async function loadPlaylistPortion(e,t){let l=YT_PLAYLIST_BASE+"&playlistId="+encodeURIComponent(e.id);"string"==typeof t&&(l+="&pageToken="+t);const o=await fetch(l).then(e=>e.json());if(o.error)throw console.error(`Playlist item portion fetch failed. Error ${o.error.code} `,o.error.message),o.error.errors&&o.error.errors.length>1&&console.warn("Additional errors:",o.error.errors),new Error(o.error.message||"Youtube API Error");return o.items.forEach(t=>{const l={title:t.snippet.title||"",channel:t.snippet.videoOwnerChannelTitle||"",id:t.snippet.resourceId.videoId};l.isBroken=!l.channel&&(!l.title||l.title.startsWith("Deleted video")||l.title.startsWith("Private video")),e.items.push(l)}),o.nextPageToken}function onYouTubeIframeAPIReady(){player=new YT.Player("YtPlayer",{width:"1280",height:"720",playerVars:{hl:"en",fs:0,iv_load_policy:3,controls:1,color:"white"},events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}}),playerIframe=player.getIframe()}function playNextSong(e=!1){playlist.index+=1,playlist.index>=playlist.items.length&&(playlist.index=0);const t=playlist.items[playlist.index],l=e||player.getPlayerState()===YT.PlayerState.PLAYING,o=l?"loadVideoById":"cueVideoById";player[o](t.id);const a=muted?"mute":"unMute";player[a](),player.setVolume(volume),document.querySelectorAll("li.active").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll("#playitem-"+playlist.index).forEach(e=>{e.classList.add("active"),e.scrollIntoViewIfNeeded&&e.scrollIntoViewIfNeeded(!1)}),playlist.saveIndex()}function updateVolume(e=0){volume=parseInt(e,10),localStorage.setItem("fp-option-volume",volume);try{player.setVolume(e)}catch(e){console.warn("Volume update on player failed",e)}}function updateMuteState(e){muted=void 0===e?!muted:Boolean(e),localStorage.setItem("fp-option-muted",muted);try{player[muted?"mute":"unMute"]()}catch(e){console.warn("Mute status update on player failed",e)}return muted?"volume_off":"volume_up"}function toggleInteractionState(e=!0){btnPlayAll.disabled=!e,btnNextSong.disabled=!e,btnShuffle.disabled=!e,optMute.disabled=!e,optVolume.disabled=!e,divLoader.style.display=e?"none":"",divContent.style.display=e?"":"none"}function onPlayerReady(){btnPlayAll.addEventListener("click",()=>{switch(player.getPlayerState()){case YT.PlayerState.PLAYING:player.pauseVideo(),userRequestedPlay=!1;break;default:player.playVideo(),userRequestedPlay=!0,waitAndSkipSong(999)}}),btnShuffle.addEventListener("click",()=>playlist.reshuffle()),btnNextSong.addEventListener("click",()=>playNextSong(!1));const e=function(){return updateVolume(this.value)};optVolume.addEventListener("input",e),optVolume.addEventListener("change",e),optVolume.addEventListener("wheel",function(e){return this.value=Number(this.value)-3*Math.sign(e.deltaY),updateVolume(this.value)}),btnUseDefaultPlaylist.addEventListener("click",()=>{toggleInteractionState(!1),playlistModalDialog.hide(),useDefaultPlaylist()}),btnUseCustomPlaylist.addEventListener("click",loadCustomPlaylist),optCustomPlaylist.addEventListener("keydown",e=>{"Enter"===e.key&&loadCustomPlaylist()}),optCustomPlaylist.addEventListener("input",()=>{txtCustomPlaylistError.innerHTML="",btnUseCustomPlaylist.innerText=optCustomPlaylist.value===playlist.id?"Update":"Load"});try{const e=localStorage.getItem(YT_STORED_ID_KEY);if(!e)throw new Error("No custom playlist stored");playlist=new ExtPlaylist(e),playlist.loadFromStorage().setReady(!0).loadShuffleState(),optCustomPlaylist.value=playlist.id,btnUseCustomPlaylist.innerText="Update",linkToPlaylist.href="https://www.youtube.com/playlist?list="+playlist.id,linkToPlaylist.innerText="custom playlist"}catch(e){console.info("Failed to load custom playlist; falling back to default.\n",e),useDefaultPlaylist()}}function onPlayerStateChange(e){switch(e.data){case YT.PlayerState.ENDED:playNextSong(!0);break;case YT.PlayerState.UNSTARTED:userRequestedPlay&&waitAndSkipSong();break;case YT.PlayerState.PLAYING:clearTimeout(stuckControl),userRequestedPlay=!0,btnPlayAll.classList.remove("btn-success"),btnPlayAll.classList.add("btn-danger"),btnPlayAllText.innerText="Stop playing",btnPlayAllIcon.innerText="stop",player[muted?"mute":"unMute"](),player.setVolume(volume);break;default:btnPlayAll.classList.add("btn-success"),btnPlayAll.classList.remove("btn-danger"),btnPlayAllText.innerText="Start playing",btnPlayAllIcon.innerText="play_arrow"}}function waitAndSkipSong(e=2e3){clearTimeout(stuckControl),stuckControl=setTimeout(()=>{player&&player.getPlayerState()<0&&playNextSong(!0)},e)}function populateVisualPlaylist(){divPlaylist.innerHTML="";const e=e=>{try{const t=e.currentTarget;if(t.classList.contains("active"))return;const l=parseInt(t.dataset.index,10);if(isNaN(l))throw new Error("Bad index: "+t.dataset.index);playlist.index=l-1,playNextSong(!0)}catch(e){console.warn("Item choice error",e)}};playlist.items.forEach((t,l)=>{const o=document.createElement("li");o.classList="list-group-item list-group-item-action flex-column-nowrap align-items-start no-select",o.id="playitem-"+l,o.dataset.index=l,o.addEventListener("click",e);const a=document.createElement("p");a.classList="m-0 text-break",t.isBroken&&(a.style.color="#995"),a.id="playitem-title-"+l,a.innerText=t.title,o.appendChild(a);const s=document.createElement("small");s.classList="yt-author text-break",s.id="playitem-author-"+l,s.innerText=t.channel,o.appendChild(s),divPlaylist.appendChild(o)})}function useDefaultPlaylist(){fetch("/data/forsen-playlist.json").then(e=>e.json()).then(e=>{playlist=new ExtPlaylist(YT_DEFAULT_PLAYLIST),playlist.items=e,playlist.setReady(!0).loadShuffleState(),localStorage.removeItem(YT_STORED_ID_KEY),btnUseCustomPlaylist.innerText="Load",linkToPlaylist.href="https://www.youtube.com/playlist?list="+YT_DEFAULT_PLAYLIST,linkToPlaylist.innerText="original Forsen playlist"}).catch(e=>{console.error("Playlist parsing error",e),showError("An error occured while retrieving list of songs.<br>Try refreshing the page. That will surely help.")})}async function loadCustomPlaylist(){txtCustomPlaylistError.innerHTML="",optCustomPlaylist.disabled=!0,btnUseCustomPlaylist.disabled=!0,btnUseCustomPlaylist.innerHTML=SpinnerHTML;try{player.pauseVideo(),userRequestedPlay=!1,playlist.setReady(!1);const e=(optCustomPlaylist.value||"").trim();if(!e)throw new Error("Please provide a YouTube link");const t=new ExtPlaylist(e);if(await t.fetchItems(),t.items.length<1)throw new Error("This playlist is empty!");playlist=t.saveToStorage(),playlist.reshuffle().setReady(!0),playlistModalDialog.hide(),linkToPlaylist.href="https://www.youtube.com/playlist?list="+playlist.id,linkToPlaylist.innerText="custom playlist"}catch(e){console.warn("Load custom playlist failed",e),txtCustomPlaylistError.innerHTML=e.message}finally{optCustomPlaylist.disabled=!1,btnUseCustomPlaylist.disabled=!1,btnUseCustomPlaylist.innerHTML="Load",playlist.setReady(!0)}}function showError(e){document.getElementById("modalPanicBody").innerHTML=e,errorModalDialog.show()}Array.prototype.shuffle=function(){for(let e=this.length-1;e>0;e--){let t=Math.floor(Math.random()*(e+1)),l=this[e];this[e]=this[t],this[t]=l}return this};const YT_DEFAULT_PLAYLIST="PLA4XEe9tV8qaSoneg5s5uJYo6HrWnT7T0",YT_API_KEY="AIzaSyBVPb_QSurBi3q18GYgw0_GfXQ55AYAH1A",YT_PLAYLIST_BASE="https://youtube.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&key="+YT_API_KEY,YT_STORED_ID_KEY="fp-external-playlist-id";class ExtPlaylist{constructor(e){if(e.indexOf("?")>0){const t=e.slice(e.indexOf("?")+1).split("&"),l=t.find(e=>e.startsWith("list="));if(!l)throw new Error("Invalid playlist link");const o=(l.slice(l.indexOf("=")+1)||"").trim();if(!o)throw new Error("Invalid playlist ID");this.id=decodeURIComponent(o)}else this.id=e;console.info("New playlist instantiated. ID: ",this.id),this.items=[],this.index=0,this.setReady(!1)}async fetchItems(){this.setReady(!1),this.items.length=0,this.index=0;let e=1;for(;e;)e=await loadPlaylistPortion(this,e);return console.info("Playlist loaded. Total item count: ",this.items.length),this.ready=!0,this}setReady(e){return this.ready=e,toggleInteractionState(e),this}reshuffle(e){return e&&(e.target.disabled=!0,userRequestedPlay=!0,setTimeout(()=>{e.target.disabled=!1},999)),this.items.shuffle(),this.index=-1,populateVisualPlaylist(),playNextSong(),this.saveShuffleState()}loadShuffleState(){if(autoReshuffle)return this.reshuffle();const e=localStorage.getItem(YT_STORED_ID_KEY);if(e&&this.id!==e)return this.reshuffle();try{const e=localStorage.getItem("fp-shuffle-order").split(","),t=[],l=new Array(this.items.length).fill(null);this.items.forEach(o=>{const a=e.indexOf(o.id);a<0?t.push(o):(l[a]&&l.splice(a,0,null),l[a]=o)}),this.items=l.filter(e=>null!==e).concat(t.shuffle());try{let e=localStorage.getItem("fp-shuffle-index");if(e=parseInt(e,10),isNaN(e))throw new Error("Bad index stored:"+e);this.index=Math.min(this.items.length,e)-1}catch(e){console.warn("Load index failed",e),this.index=-1}if(populateVisualPlaylist(),playNextSong(),t.length>0){const e=new bootstrap.Popover(btnGroupShuffle,{html:!0,trigger:"focus",placement:"bottom",title:"ðŸŽ¶ Playlist updated!",content:"New songs were added.<br>You may want to <b>reshuffle</b> the list.",template:'<div class="popover pop-taunt" role="tooltip" title="Click to dismiss"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>'});e.show();const t=function(l){e.hide(),l.currentTarget.removeEventListener(l.type,t)};e.tip.addEventListener("click",t),btnGroupShuffle.addEventListener("click",t)}}catch(e){return console.warn("Load shuffle failed",e),this.reshuffle()}return this.saveShuffleState()}saveShuffleState(){const e=this.items.map(e=>e.id).join(",");return localStorage.setItem("fp-shuffle-order",e),this.saveIndex()}saveIndex(){return localStorage.setItem("fp-shuffle-index",this.index),this}loadFromStorage(){try{const e=JSON.parse(localStorage.getItem("fp-external-playlist-data"));if(!Array.isArray(e))throw new Error("LocalStorage data is not valid");this.items=e,this.ready=!0}catch(e){console.warn("ExtPlaylist load failed",e)}return this}saveToStorage(){return localStorage.setItem(YT_STORED_ID_KEY,this.id),localStorage.setItem("fp-external-playlist-data",JSON.stringify(this.items)),this}}const linkToPlaylist=document.getElementById("nowPlayingList"),divLoader=document.getElementById("loader"),divContent=document.getElementById("content"),divPlaylist=document.getElementById("playlistItems"),btnUseDefaultPlaylist=document.getElementById("doUseDefaultPlaylist"),btnUseCustomPlaylist=document.getElementById("doUseCustomPlaylist"),txtCustomPlaylistError=document.getElementById("customPlaylistError"),optCustomPlaylist=document.getElementById("inputPlaylistLink"),optAutoReshuffle=document.getElementById("optShuffleOnRefresh"),optMute=document.getElementById("muteButton"),optVolume=document.getElementById("volumeSlider"),btnPlayAll=document.getElementById("doPlay"),btnPlayAllIcon=document.getElementById("doPlayButtonIcon"),btnPlayAllText=document.getElementById("doPlayButtonText"),btnNextSong=document.getElementById("doSkipSong"),btnGroupShuffle=document.getElementById("ctrlGroupShuffle"),btnShuffle=document.getElementById("doShuffle"),SpinnerHTML='<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>';let player,playerIframe,stuckControl=null,userRequestedPlay=!1,playlist=null,autoReshuffle="true"===localStorage.getItem("fp-option-autoshuffle");optAutoReshuffle.checked=autoReshuffle,optAutoReshuffle.addEventListener("change",()=>{autoReshuffle=optAutoReshuffle.checked,localStorage.setItem("fp-option-autoshuffle",autoReshuffle)});let muted="true"===localStorage.getItem("fp-option-muted"),volume=localStorage.getItem("fp-option-volume");(null===volume||isNaN(volume)||volume<0||volume>100)&&(volume=70),optVolume.value=volume,optMute.firstElementChild.innerText=updateMuteState(muted);const tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";const firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);const errorModalDialog=new bootstrap.Modal(document.getElementById("modalPanic")),helperModalDialog=new bootstrap.Modal(document.getElementById("modalHelper")),helperModalButton=document.getElementById("helperButton");helperModalButton.addEventListener("click",()=>{helperModalDialog.show()});const playlistModalDialog=new bootstrap.Modal(document.getElementById("modalExtPlaylist")),playlistModalButton=document.getElementById("doChangePlaylist");playlistModalButton.addEventListener("click",()=>{playlistModalDialog.show()}),document.querySelectorAll('main [data-bs-toggle="tooltip"]').forEach(e=>new bootstrap.Tooltip(e,{placement:"bottom",delay:200,trigger:"hover"})),window.addEventListener("message",function(e){if(playerIframe&&e.source===playerIframe.contentWindow){const t=JSON.parse(e.data);"infoDelivery"===t.event&&t.info&&("volume"in t.info&&t.info.volume!==volume&&(volume=t.info.volume,optVolume.value=volume,localStorage.setItem("fp-option-volume",Math.floor(volume))),"muted"in t.info&&t.info.muted!==muted&&(muted=t.info.muted,optMute.firstElementChild.innerText=muted?"volume_off":"volume_up",localStorage.setItem("fp-option-muted",muted)))}});